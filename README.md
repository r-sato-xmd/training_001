# 売上データ分析AIチャットボット

自然言語で売上データについて質問すると、AIが適切なSQLを生成して分析結果をグラフと表で表示するStreamlitアプリケーションです。

## 機能

- 📊 **自然言語クエリ**: 日本語で売上データについて質問
- 🤖 **AI SQL生成**: OpenAI GPT-4o-miniがSQLクエリを自動生成
- 📈 **豊富な可視化**: 12種類の可視化手法（下記参照）
- 🛡️ **セキュリティ**: SELECT文のみ許可、危険なSQL操作をブロック
- 🔄 **フォールバック**: SQL生成に失敗した場合の代替集計
- 💾 **DuckDB**: 高速なインメモリSQL分析エンジン

## 利用可能な可視化手法

| 種別 | 用途 | 例 |
|-----|------|-----|
| **bar** | カテゴリ別比較 | 地域別売上、チャネル別売上 |
| **line** | 時系列トレンド | 月別売上推移 |
| **line_point** | 時系列詳細 | 日別売上（ポイント付き） |
| **area** | 面積表示・積み上げ | 累積売上、カテゴリ積み上げ |
| **pie** | 構成比 | カテゴリ別売上構成比 |
| **scatter** | 相関関係 | 単価×数量の関係 |
| **boxplot** | 分布・外れ値 | カテゴリ別単価分布 |
| **heatmap** | 2次元強度 | 月×カテゴリの売上ヒートマップ |
| **errorbar** | 平均±信頼区間 | 月別売上の平均と標準偏差 |
| **rule** | 基準線・回帰線 | 目標売上ライン |
| **density** | 密度分布 | 売上額の分布密度 |
| **table** | 生データ表示 | 詳細データテーブル |

## セットアップ

### 前提条件

- Python 3.10+
- uv (Pythonパッケージマネージャー)

### インストール

1. **プロジェクトのクローンまたはダウンロード**

```bash
git clone <このリポジトリのURL>
cd learning_program
```

2. **依存関係のインストール**

```bash
# uvがインストールされていない場合
curl -LsSf https://astral.sh/uv/install.sh | sh

# 依存関係をインストール
uv sync
```

3. **環境変数の設定**

```bash
# OpenAI API キーを設定
export OPENAI_API_KEY="your-openai-api-key-here"
```

または、`.env`ファイルを作成：

```bash
echo "OPENAI_API_KEY=your-openai-api-key-here" > .env
```

### データファイル

アプリケーションは `data/sample_sales.csv` の売上データを使用します。このファイルには以下の列が含まれている必要があります：

- `date`: 日付 (YYYY-MM-DD形式)
- `category`: 商品カテゴリ
- `units`: 販売数量
- `unit_price`: 単価
- `region`: 地域
- `sales_channel`: 販売チャネル (Online, Retail, Partner等)
- `customer_segment`: 顧客セグメント (Enterprise, Consumer等)
- `revenue`: 売上額

## 起動方法

```bash
# uvを使用して起動
uv run streamlit run chatbot_app.py

# または直接実行
streamlit run chatbot_app.py
```

ブラウザで `http://localhost:8501` にアクセスしてアプリケーションを利用できます。

## 使用方法

### 質問例

以下のような自然言語の質問に答えることができます：

1. **基本的な分析**
   - "月別カテゴリ別の売上を教えて" → 棒グラフ
   - "販売チャネル別の売上を見せて" → 棒グラフ

2. **時系列分析**
   - "月別の売上推移を線グラフで" → 線グラフ
   - "売上トレンドをエリアチャートで" → 面グラフ

3. **分布・統計分析**
   - "カテゴリ別の単価分布を箱ひげ図で" → 箱ひげ図
   - "売上額の密度分布を見せて" → 密度プロット
   - "単価と数量の関係を散布図で" → 散布図

4. **構成比・ヒートマップ**
   - "カテゴリ別売上の構成比を円グラフで" → 円グラフ
   - "月別・地域別のヒートマップ" → ヒートマップ

### UI構成

- **左サイドバー**: データの概要情報（件数、期間、カテゴリなど）
- **中央エリア**: チャット形式の質問・回答インターフェース
- **回答形式**: 
  1. 日本語の分析結果説明
  2. 実行されたSQL（折りたたみ表示）
  3. データテーブル
  4. 可視化グラフ

## セキュリティ機能

- **SQL制限**: SELECT文のみ実行許可
- **危険操作ブロック**: CREATE, INSERT, UPDATE, DELETE等を禁止
- **セミコロン制限**: SQLインジェクション攻撃を防止
- **結果制限**: 最大100件までの結果表示

## フォールバック機能

LLMがSQL生成に失敗した場合、以下の優先順位で代替集計を実行：

1. 月別×カテゴリ別売上（"月"と"カテゴリ"キーワードを検出）
2. チャネル別売上（"チャネル"と"売上"キーワードを検出）
3. 地域別売上（"地域"と"売上"キーワードを検出）
4. デフォルト：全データの先頭50件

## 技術仕様

- **フレームワーク**: Streamlit
- **データベース**: DuckDB (インメモリ)
- **可視化**: Altair (12種類の可視化手法対応)
- **データ処理**: pandas
- **AI**: OpenAI GPT-4o-mini
- **言語**: Python 3.10+

## トラブルシューティング

### よくある問題

1. **OpenAI APIキーエラー**
   ```
   OPENAI_API_KEY 環境変数が設定されていません
   ```
   → 環境変数 `OPENAI_API_KEY` を正しく設定してください

2. **データファイルが見つからない**
   ```
   データファイルの読み込みエラー: [Errno 2] No such file or directory: 'data/sample_sales.csv'
   ```
   → `data/sample_sales.csv` ファイルが存在することを確認してください

3. **依存関係エラー**
   ```
   ModuleNotFoundError: No module named 'streamlit'
   ```
   → `uv sync` を実行して依存関係をインストールしてください

4. **可視化エラー**
   ```
   チャート描画エラー: Unable to determine data type
   ```
   → データ型が不適切な場合は自動的に表形式にフォールバックします

### デバッグモード

詳細なエラー情報を確認したい場合：

```bash
# Streamlitのデバッグモードで起動
uv run streamlit run chatbot_app.py --server.runOnSave true --logger.level debug
```

## 制約事項

- OpenAI APIの利用制限に依存
- CSV形式のデータファイルが必要
- 大容量データ（数万件以上）では処理が遅くなる可能性
- インメモリデータベースのため、アプリ再起動時にデータがリセット
- 一部の複雑な可視化は自動的に表形式にフォールバック

## ライセンス

MIT License

## 貢献

バグレポートや機能要望は Issues でお知らせください。